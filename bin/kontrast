#!/usr/bin/env ruby
begin
    require "rubygems"
    require "kontrast"
rescue LoadError => e
    puts "Could not load Kontrast."
    raise e
end
require "thor"

module Kontrast
    class CLI < Thor
        desc "run_tests CONFIG_FILE", "Run Kontrast test suite"
        def run_tests(config)
            load_config(config)
            Kontrast.run
        end

        desc "make_gallery CONFIG_FILE PATH", "Create gallery given a path of test results"
        def make_gallery(config, path = nil)
            load_config(config)

            # We're only allowed to give no path in the remote case
            if path.nil? && !Kontrast.configuration.remote
                raise GalleryException.new("You can't omit a path when running in remote mode.")
            end

            Kontrast.make_gallery(path)
        end

        desc "local_run CONFIG_FILE", "Run Kontrast locally"
        def local_run(config)
            load_config(config)

            # Run Kontrast
            Kontrast.run
            Kontrast.make_gallery(Kontrast.path)
        end

        private
            def load_config(config)
                begin
                    require config
                rescue LoadError => e
                    raise ConfigurationException.new("Could not load the given config file.")
                end

                # Check that we actually got a configuration block
                if !Kontrast.configuration
                    raise ConfigurationException.new("No configuration was found in the given file.")
                end

                # Make sure we have the bare minimum configuration to continue
                Kontrast.configuration.validate

                return true
            end
    end
end

Kontrast::CLI.start(ARGV)
